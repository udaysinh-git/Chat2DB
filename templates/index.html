{% extends 'layout.html' %}

{% block content %}
<div class="container-fluid h-100">
    <div class="row h-100">
        <!-- Sidebar -->
        <div class="col-md-3 col-lg-2 sidebar">
            <h5>Database Connection</h5>
            <form id="connection-form" class="connection-form" hx-post="/connect" hx-target="#connection-status">
                <div class="mb-2">
                    <label for="host" class="form-label">Host</label>
                    <input type="text" class="form-control form-control-sm" id="host" name="host" value="localhost">
                </div>
                <div class="mb-2">
                    <label for="port" class="form-label">Port</label>
                    <input type="text" class="form-control form-control-sm" id="port" name="port" value="3306">
                </div>
                <div class="mb-2">
                    <label for="user" class="form-label">User</label>
                    <input type="text" class="form-control form-control-sm" id="user" name="user" value="root">
                </div>
                <div class="mb-2">
                    <label for="password" class="form-label">Password</label>
                    <input type="password" class="form-control form-control-sm" id="password" name="password" value="admin">
                </div>
                <div class="mb-2">
                    <label for="database" class="form-label">Database</label>
                    <input type="text" class="form-control form-control-sm" id="database" name="database" value="Chinook">
                </div>
                <button type="submit" class="btn btn-primary btn-sm w-100">Connect</button>
            </form>
            <div id="connection-status" class="mt-3"></div>
        </div>
        
        <!-- Main Chat Area -->
        <div class="col-md-9 col-lg-10">
            <div class="chat-container">
                <div id="messages" class="messages-container">
                    {% for message in chat_history %}
                        {% if message.role == 'human' %}
                        <div class="message user-message show">
                            <div class="message-header">You:</div>
                            <div class="message-content">{{ message.content }}</div>
                        </div>
                        {% else %}
                        <div class="message ai-message show">
                            <div class="message-header">AI:</div>
                            <div class="message-content rendered-markdown">{{ message.content | safe }}</div>
                        </div>
                        {% endif %}
                    {% endfor %}
                    <div id="typing-indicator" class="typing-indicator ai-message">
                        <div class="typing-bounce"></div>
                        <div class="typing-bounce"></div>
                        <div class="typing-bounce"></div>
                    </div>
                </div>
                
                <div class="input-area">
                    <form id="chat-form" hx-post="/chat" hx-swap="none" hx-indicator="#typing-indicator">
                        <div class="input-group">
                            <input type="text" id="message-input" name="message" class="form-control" placeholder="Type your message..." required>
                            <button class="btn btn-primary" type="submit">Send</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Process and render markdown content
    function renderMarkdown(content) {
        return marked.parse(content);
    }
    
    // Apply syntax highlighting to rendered content
    function applyHighlighting() {
        Prism.highlightAll();
    }
    
    // Format markdown tables
    function processTables() {
        document.querySelectorAll('table').forEach(function(table) {
            if (!table.classList.contains('markdown-table')) {
                table.classList.add('markdown-table', 'table', 'table-striped');
                
                // Make sure it has thead and tbody
                if (!table.querySelector('thead')) {
                    const thead = document.createElement('thead');
                    const firstRow = table.querySelector('tr');
                    if (firstRow) {
                        thead.appendChild(firstRow);
                        table.prepend(thead);
                    }
                }
            }
        });
    }
    
    // Process JSON content in responses
    function processJSONContent(content) {
        // Look for JSON strings that are not inside code blocks
        return content.replace(/```json([\s\S]*?)```/g, function(match, jsonContent) {
            return `<div class="json-block">${formatJSON(jsonContent)}</div>`;
        });
    }

    htmx.on("htmx:beforeRequest", function(evt) {
        if (evt.detail.target.id === "chat-form") {
            const message = document.getElementById('message-input').value;
            
            // Add user message to UI immediately with animation
            const userMessageHtml = `
            <div class="message user-message">
                <div class="message-header">You:</div>
                <div class="message-content">${message}</div>
            </div>
            `;
            
            const messagesDiv = document.getElementById('messages');
            messagesDiv.insertAdjacentHTML('beforeend', userMessageHtml);
            
            // Animate the new message
            setTimeout(() => {
                messagesDiv.lastElementChild.classList.add('show');
            }, 10);
            
            // Show typing indicator
            document.getElementById('typing-indicator').style.display = 'block';
            
            // Scroll to bottom
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            
            // Clear input
            document.getElementById('message-input').value = '';
        }
    });
    
    htmx.on("htmx:afterRequest", function(evt) {
        if (evt.detail.target.id === "chat-form") {
            // Hide typing indicator
            document.getElementById('typing-indicator').style.display = 'none';
            
            // Check if response was successful
            try {
                const response = JSON.parse(evt.detail.xhr.responseText);
                
                if (response.success) {
                    // Process and format the response content
                    let formattedMessage = response.message;
                    
                    // Process any JSON content first
                    formattedMessage = processJSONContent(formattedMessage);
                    
                    // Render markdown
                    const renderedContent = renderMarkdown(formattedMessage);
                    
                    // Create AI message element with animation
                    const aiMessageHtml = `
                    <div class="message ai-message">
                        <div class="message-header">AI:</div>
                        <div class="message-content rendered-markdown">${renderedContent}</div>
                    </div>
                    `;
                    
                    const messagesDiv = document.getElementById('messages');
                    messagesDiv.insertAdjacentHTML('beforeend', aiMessageHtml);
                    
                    // Get the newly added message
                    const newMessage = messagesDiv.lastElementChild;
                    
                    // Apply animation after a short delay
                    setTimeout(() => {
                        newMessage.classList.add('show');
                        
                        // Apply syntax highlighting
                        Prism.highlightAll();
                        
                        // Format tables
                        processTables();
                        
                        // Scroll to the bottom
                        messagesDiv.scrollTop = messagesDiv.scrollHeight;
                    }, 10);
                } else {
                    // Show error message with animation
                    const errorHtml = `
                    <div class="message ai-message">
                        <div class="message-header">Error:</div>
                        <div class="message-content text-danger">${response.message}</div>
                    </div>
                    `;
                    
                    const messagesDiv = document.getElementById('messages');
                    messagesDiv.insertAdjacentHTML('beforeend', errorHtml);
                    
                    setTimeout(() => {
                        messagesDiv.lastElementChild.classList.add('show');
                        messagesDiv.scrollTop = messagesDiv.scrollHeight;
                    }, 10);
                }
            } catch (error) {
                console.error("Failed to parse response:", error);
            }
        } else if (evt.detail.target.id === "connection-form") {
            const response = JSON.parse(evt.detail.xhr.responseText);
            
            // Show connection status with animation
            const statusClass = response.success ? 'alert-success animate__animated animate__fadeIn' : 'alert-danger animate__animated animate__shakeX';
            const statusHtml = `<div class="alert ${statusClass}">${response.message}</div>`;
                
            document.getElementById('connection-status').innerHTML = statusHtml;
        }
    });
    
    // Initialize any existing markdown content
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.rendered-markdown').forEach(function(el) {
            // Re-render any existing markdown content
            el.innerHTML = renderMarkdown(el.innerHTML);
        });
        
        // Apply syntax highlighting
        applyHighlighting();
        
        // Process tables
        processTables();
    });
    
    // Set up HTMX enhancement for chat form
    document.getElementById('chat-form').addEventListener('submit', function(e) {
        e.preventDefault(); // Prevent default form submission
        
        const message = document.getElementById('message-input').value;
        if (!message.trim()) return;
        
        // Use HTMX to trigger the request
        htmx.trigger('#chat-form', 'submit');
    });
</script>
{% endblock %}
